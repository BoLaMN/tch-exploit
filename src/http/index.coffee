{ Duplex } = require 'stream'
{ createServer } = require 'https'
{ readFileSync, existsSync, statSync } = require 'fs'

path = require 'path'

file = require './file'
route = require './router'
args = require '../args'
cwmp = require './cwmp'

module.exports = (ip, port, url) ->

  if args.file
    file.name = path.basename args.file

    try
      file.data = readFileSync args.file
    catch e
      throw e

  file.data = Buffer.from file.data
    .toString 'utf8'
    .replace '{{url}}', url
  , 'utf8'

  file.ext = path.extname file.name

  route
    .get "/#{file.name}", (req, res) ->
      ext = file.ext.toUpperCase()

      console.log ">>> #{ ext } REQUEST"

      headers =
        'Content-Type': 'text/plain'
        'Content-Length': file.data.length

      console.log '>>> #{ ext } RESPONSE'
      console.dir [headers, file.data.toString('utf8')]

      res.writeHead 200, headers

      stream = new Duplex()
      stream.push file.data
      stream.push null
      stream.pipe res
    .get '/done', (req, res) ->
      console.log '>>> WPS CALLBACK'
      console.log """\n
        All done,

        - change network card settings back to dhcp and move the cable back to a lan port
        - try ssh connection to the gateways ip (usually 192.168.0.1) with username root and password root (change password immediately with passwd!)

        ssh root@192.168.0.1"""

      setTimeout ->
        process.exit 1
      , 20000

      res.writeHead 200
      res.end()

    .post '/', cwmp(url)

  srv = createServer route
  srv.keepAliveTimeout = 30000

  srv.on 'error', (e) ->
    if e.code in [ 'EADDRINUSE', 'EADDRNOTAVAIL' ]
      console.log e.code + ', retrying...'

      setTimeout ->
        srv.close()
        srv.listen port
      , 1000
    else console.error e

  srv.listen port

  srv
