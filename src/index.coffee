pkg = require '../package.json'
args = require './args'

ip = args.ip or '58.162.0.1'

console.log """
Technicolor OpenWRT Shell Unlocker v#{ pkg.version } By BoLaMN

* Connect network cable from your computer to the WAN (red) port of the modem
* Change your computers network card to be a static ip address

  IPv4 Address: #{ ip }
  Subnet Mask: 255.255.255.0
  Default Gateway\\Router: #{ ip }

"""

ask = require './ask'
dhcpd = require './dhcp'
httpd = require './http'
port = require './get-port'
tftp = require './tftp'
dns  = require './dns'

servers = []

#args.tftp = '/Users/nathan/Desktop/images/'
#args.ip = "192.168.0.100"

if args.tftp
  servers.push tftp(args)...
else if args.dhcponly
  servers.push dhcpd ip, args.acsurl, args.acspass
else
  ask ip
  .then port
  .then (p) ->
    u = new URL args.acsurl or "http://#{ ip }"
    u.port = p

    url = u.toString()

    console.log "listening for cwmp requests at #{ url }"

    dns.route '*', ip
    #dns.route 'fbbwan.telstra.net', ip
    #dns.route 'dynupdate.no-ip.com', ip

    dns.listen()

    servers.push dhcpd ip, url, args.acspass
    servers.push httpd ip, p, url

if process.platform is 'win32'
  rl = require('readline').createInterface
    input: process.stdin
    output: process.stdout

  rl.on 'SIGINT', ->
    process.emit 'SIGINT'

process.on 'SIGINT', ->
  console.log "\nshutting down servers from SIGINT (Ctrl+C)"

  servers.forEach (server) ->
    server.close()

  setTimeout ->
    process.exit()
  , 2000

module.exports = servers